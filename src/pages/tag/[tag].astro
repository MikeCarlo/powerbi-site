---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  
  // Extract all unique tags from all posts
  const tagMap = new Map();
  
  posts.forEach(post => {
    post.data.tags?.forEach(tag => {
      const slug = tag.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
      if (!tagMap.has(slug)) {
        tagMap.set(slug, { name: tag, slug, posts: [] });
      }
      tagMap.get(slug).posts.push(post);
    });
  });
  
  return Array.from(tagMap.values()).map(tag => ({
    params: { tag: tag.slug },
    props: { 
      tag: tag.name,
      posts: tag.posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
    }
  }));
}

const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const { tag, posts } = Astro.props;
---

<BaseLayout title={`${tag} | PowerBI.tips`} description={`All posts tagged with ${tag}`}>
  <section class="mb-12">
    <p class="text-sm font-semibold uppercase tracking-wide text-blue-600">Tag</p>
    <h1 class="mt-3 text-4xl font-semibold tracking-tight text-neutral-900">
      #{tag}
    </h1>
    <p class="mt-4 text-lg text-neutral-600">
      {posts.length} {posts.length === 1 ? 'post' : 'posts'}
    </p>
  </section>

  <div class="grid gap-6">
    {posts.map((post) => {
      const slug = post.id.replace(/\/index\.mdx?$/, '').replace(/\.mdx?$/, '');
      return (
        <article class="flex items-center gap-6 rounded-xl border border-neutral-200 p-4">
          {post.data.featuredImage && (
            <a href={`${base}${slug}/`} class="shrink-0">
              <Image 
                src={post.data.featuredImage} 
                alt={post.data.title}
                width={180}
                height={101}
                class="h-[80px] w-[142px] rounded-lg object-cover"
              />
            </a>
          )}
          <div class="flex-1">
            <p class="text-xs font-semibold uppercase tracking-wide text-neutral-500">
              {post.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
            </p>
            <h2 class="mt-1 text-lg font-semibold">
              <a class="text-blue-600 hover:text-blue-700" href={`${base}${slug}/`}>
                {post.data.title}
              </a>
            </h2>
            {post.data.excerpt && (
              <p class="mt-2 text-sm text-neutral-600 line-clamp-2">{post.data.excerpt}</p>
            )}
          </div>
        </article>
      );
    })}
  </div>
  
  <div class="mt-8">
    <a href={`${base}tag/`} class="text-sm font-semibold text-blue-600 hover:text-blue-700">
      ‚Üê All Tags
    </a>
  </div>
</BaseLayout>
