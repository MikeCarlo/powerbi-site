---
import { getCollection, render } from 'astro:content';
import BlogPost from '../layouts/BlogPost.astro';

function cleanSlug(id: string): string {
  return id.replace(/\/index\.mdx?$/, '').replace(/\.mdx?$/, '');
}

export async function getStaticPaths() {
  const posts = await getCollection('blog');

  return posts.map((post) => ({
    params: { slug: post.id.replace(/\/index\.mdx?$/, '').replace(/\.mdx?$/, '') },
    props: { post }
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const allPosts = (await getCollection('blog'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .map((entry) => ({
    ...entry,
    slug: cleanSlug(entry.id)
  }));

const currentIndex = allPosts.findIndex((entry) => entry.id === post.id);
const prev = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const next = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const morePosts = allPosts.filter((entry) => entry.id !== post.id).slice(0, 3);
---

<BlogPost entry={post} prev={prev} next={next} morePosts={morePosts}>
  <Content />
</BlogPost>
